#!/usr/bin/env bash

set -eu

SOURCE_BRANCH=develop
TARGET_BRANCH=gh-pages-master
SUBTREE_BRANCH=gh-pages
REPO=git@github.com:nenadalm/hours-counter.git

if [[ "${TRAVIS_PULL_REQUEST}" != "false" || "${TRAVIS_BRANCH}" != "${SOURCE_BRANCH}" ]]; then
    printf "Current branch is not ${SOURCE_BRANCH}. Skipping deploy...\n"
    exit 0
fi

# ssh key
openssl aes-256-cbc -K $encrypted_c8fc93de755f_key -iv $encrypted_c8fc93de755f_iv -in .travis/id_rsa.enc -out .travis/id_rsa -d
eval "$(ssh-agent -s)"
chmod 600 .travis/id_rsa
ssh-add .travis/id_rsa

git config user.name "Travis CI"
git config user.email "travis@example.com"
git remote add premote "${REPO}"
git fetch premote

if git rev-parse --quiet --verify "premote/${TARGET_BRANCH}"; then
    git checkout -b "${TARGET_BRANCH}" "premote/${TARGET_BRANCH}"
else
    git checkout -b "${TARGET_BRANCH}"
fi
git merge -m "Travis-CI: Merge branch '${SOURCE_BRANCH}' into ${TARGET_BRANCH}" "${SOURCE_BRANCH}"

git add --force resources/public && git commit -m "Travis-CI: update resources" || true

git push premote "${TARGET_BRANCH}:${TARGET_BRANCH}"
git subtree push --prefix resources/public premote "${SUBTREE_BRANCH}"

